% Copyright Â© 2011-2013 Jesse DeGuire
%
% This file is part of Projector Controller.
%
% This work is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. You
% should have received a copy of the license along with this work.  If not, see
% <http://creativecommons.org/licenses/by-sa/3.0/>.
%
% File:   devguide.tex
% Author: Jesse DeGuire
%
% LaTeX source for the PJC Developers Guide document.  This can be made into a PDF using a suitable
% LaTeX distribution such as TeX Live for GNU/Linux or MiKTeX for Windows.

\documentclass{article}

\usepackage{textcomp}
\usepackage{textgreek}
\usepackage{anysize} 
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{floatflt} 
\usepackage[pdftex]{hyperref}
\hypersetup{colorlinks=true, urlcolor=cyan, linkcolor=blue}

\marginsize{.75in}{.75in}{.75in}{.75in}

% just so that the document revision is somewhere convenient
\newcommand{\docrev}{A}

% makes a backslash
\newcommand{\bs}{$\backslash$}

% degree symbol and overbar in either math or text mode
% found these on the TeX Stack Exchange
\newcommand{\degree}{\ensuremath{^{\circ}}}
\newcommand{\textoverline}[1]{$\overline{\mbox{#1}}$}

% enclose argument in angle brackets
\newcommand{\abrackets}[1]{\textlangle #1\textrangle}


\begin{document}

% don't add extra space to sentence ends when justifying text
\frenchspacing

\noindent {\Huge Projector Controller} \\
{\large Developers Guide} Rev. \docrev \\
Author: Jesse DeGuire \\
Email: \href{mailto:jesse.a.deguire+pjc@gmail.com}{jesse.a.deguire+pjc@gmail.com} \\
Date: \today \\

\tableofcontents

% redefine \section command to start section on new page
\let\stdsection\section
\renewcommand{\section}{\newpage\stdsection}

% additional space between paragraphs
\addtolength{\parskip}{6pt}

\section*{Revision History}
\phantomsection
This section describes revisions made to this document.  Changes made to the hardware, firmware, or
software are described in their respective sections.

\begin {description}
  \item[Rev. A:] February 3, 2013 \\
    Initial revision.
\end {description}

\section{Introduction}
This document provides implementation details for the various pieces of the Projector Controller
system.  The information contain within will hopefully be useful for anyone who wishes to modify or
tinker with the any part of the system or at least will satisfy an interested user's curiosity.
Anyone who is only looking to get the Controller running in his or her projector should instead
consult the \textit{Projector Controller Users Guide}.

This guide is divided up into a few sections.  The \hyperref[sec:Hardware]{Hardware} section
describes the components used on the board itself as well as the power requirements and capabilities
of the board.  The \hyperref[sec:Firmware]{Firmware} section contains information regarding the
program flow of the bootloader and application firmwares used by the Projector Controller.  This
also contains documentation for the command interfaces used by both to communicate to the host PC as
well as brief descriptions of many of the source code files.  Finally, the
\hyperref[sec:Software]{Software} section describes how the PC-side software communicates to the
board.  All sections will additionally state what tools were used in their development so that
anyone can build and modify the various pieces.

\subsection{Sources and Licenses} \label{ssec:SourceLic}
All source files used to create the board, software, and firmwares are available in a Git repository
on GitHub at \url{https://github.com/jdeguire/pjcontroller}.  The repository also contains
datasheets for the hardware components and other reference material.

The firmware and software, the sources of which are located in the \texttt{firmware/} and
\texttt{software/} directories in the aforementioned repository, are made available under the GNU
Public License Version 3.  A copy of the GPLv3 is provided in the file \texttt{COPYING.txt} in the
repository root or online at \url{http://www.gnu.org/licenses/}.

This document, the \textit{Users Guide}, their associated \LaTeX{} source files, and the board
design files are all made available under the Creative Commons Attribution-ShareAlike 3.0 Unported
License.  The source files for the \textit{Developers Guide} and \textit{Users Guide} are available
in the \texttt{docs/tex/} directory.  The board design files are found in
\texttt{hardware/pjc-kicad/}.  A copy of the Creative Commons BY-SA 3.0 license is provided in the
file \texttt{CC BY-SA 3.0 legalcode.txt} in the repository root or online at
\url{http://creativecommons.org/licenses/by-sa/3.0/}.

Where attribution is required, it is sufficient to include a statement of reasonable visibility in
the derived work or supporting documentation mentioning that the work is derived from this project
and giving this author's name.  It would be appreciated if the statement also contained the URL,
given above, for the version control repository.

Located in \texttt{hardware/pjc-kicad/libs} are two files \texttt{SparkFun.lib} and
\texttt{SparkFun.mod}.  These were converted into their current form for use with KiCad from the
original Eagle libraries provided by SparkFun Electronics under the CC BY-SA 3.0 license.  The
latest such libraries can be found on GitHub at
\url{https://github.com/sparkfun/SparkFun-Eagle-Libraries}.

\subsection{Open Source Hardware} \label{ssec:OpenSourceHW}
\begin{floatingfigure}{0.22\textwidth}
    \centering
    \vspace{-6pt}
    \includegraphics[width=0.17\textwidth]{oshw-logo-200-px}
\end{floatingfigure}

As described above, all design and source code files for Projector Controller are available under
licenses allowing one to ``study, modify, distribute, make, and sell the design or hardware based on
that design''.  The project was developed using freely-available tools, most of which are also open
source, lowering the barrier to accessing the design.  Therefore, the author believes that the
Projector Controller qualifies as Open Source Hardware as given in the Open Source Hardware
Definition 1.0.  The defintions is availabe from the Open Source Hardware Association at
\url{http://www.oshwa.org/definition/}.

Note that the logo itself does not have a license associated with it, but the guidelines presented
at \url{http://www.oshwa.org/faq/} recommded its use.  Any derived works which do not adhere to the
definition of Open Source Hardware should remove the logo from any files which contain it.


\section{Hardware} \label{sec:Hardware}
The hardware was designed using KiCad EDA, an open source (GPLv2) multi-purpose EDA tool available
for various flavors of GNU/Linux, Windows, and OS X.  Get KiCad from the official site at
\url{http://www.kicad-pcb.org/display/KICAD/Download+Kicad}.  If possible, download a Snapshot build
as those contain additional features over the rather old stable release.  Ubuntu users should use
the Adam Wolf PPA given on that page.

Datasheets for the various components used are available in the repository under
\texttt{hardware/datasheets}.  The datasheets are provided for reference only and belong to their
respective manufacturers.

\subsection{Design Considerations} \label{ssec:DesignConsid}
Becuase the Projector Controller will probably never acheive high-volume production, the main
consideration was ease of assembly.  When possible, the components used are of a large form factor
(such as 1206 for resistors) and the footprints for surface-mount devices use long pads to make
accessing them with a soldering iron easier.  The board uses a socket for the 28-pin DIP
microcontroller to allow easy replacement.  These choices allow the board to be assembled by hand
for small production runs and allow the user to more easily tinker with the board.

Other considerations were size of the board itself and price, which are related since larger PCBs
are more expensive.  These may seem to conflict with the previous consideration, but the Controller
is relatively simple, making use of not many components and reusing multiple of the same component
when possible (the board uses multiple 10k\textOmega{} resistors, for example).  Fewer components also
means a smaller board size and less assembly.  A smaller board size means that the device will be
easier to install into one's projector.

Though not a primary consideration, the board was also designed with an eye on power consumption.
The board will be able to run certain componenets from USB power.  USB provides 5V at 100mA by
default, though a device can request up to 500mA.  The USB interface device does not identify itself
as a high-power device by default, so all 5V components will need to consume less than 100mA
combined.  The power consumption of the board is characterized in the
\hyperref[ssec:PowerUsage]{Power Usage} section.

\subsection{Circuit Details} \label{ssec:CircuitDetails}
Following are desciptions of the different circuit pieces developed for the board.  The reader of
this section may want to have the schematic handy in order to follow along.  The titles of the
descriptions will closely match the text titles used in the schematic for the different circuits.

\subsubsection{Microcontroller} \label{sssec:Microcontroller}
The heart of the Projector Controller is an Atmel ATMega328p 8-bit microcontroller.  The MCU has
32KB of flash, 4KB of which is used for the bootloader, 2KB of RAM and several useful peripherals,
such as 10-bit ADCs, SPI, PWM outputs, timers, and quite a few IO pins.  The MCU is a 28-pin DIP
package which will insert into a socket on the board, making removal and replacement easy.

A Fox 20MHz crystal oscillator provides the CPU clock.

Three LEDs--red, yellow, and green--are provided to allow the firmware to convey diagnostic
information while running.  The LED outputs also control low-side drivers, which is explained in the
\hyperref[sssec:RelayLED]{Relay and LED Outputs} description.

A jumper, pulled low, is connected to an IO pin on the microcontroller.  Shorting the jumper sets
the state of that IO pin high.  The state of this pin is read by the bootloader when it first starts
up.  If the pin state is high, the bootloader will not start the application and will instead stay
in the bootloader.  This allows one to recover from a problematic application that fails on startup.

\subsubsection{USB/UART IO} \label{sssec:USBUART}
The Projector Controller communicates with the outside world by utilizing an FTDI FT232R UART to
USB interface chip.  The chip connects to a standard USB Mini-B connector on one side and the
microcontroller's logic-level UART pins on the other, acting as a translator between the two
protocols.  The chip presents itself to the connected USB host as a virutal COM port to
allow one to communicate with the board using a terminal program such as TeraTerm or HyperTerminal.
Newer operating systems should have drivers for the device pre-installed; however, drivers are also
available from \url{http://www.ftdichip.com/FTDrivers.htm}.

The circuit used is similar to the one presented in Section 6.3 of the FT232R datasheet.  Because
the 5V components on the board can be powered over USB (see the \hyperref[sssec:MainPower]{Main
  Power Input} description), this device needs to comply with USB suspend mode requirements.  When
the USB host enters USB Suspend Mode, the attached device must power down and draw less than 2.5mA
of current.  To facilitate this, pin 14 of the FT232R defaults to an active low ``Power Enable'' pin.
When entering USB suspend mode, that pin will be pulled high by the 10k\textOmega{} pullup and will
``turn off'' the Diodes Inc. DMP2215L P-channel MOSFET, essentially cutting power to the rest of the
5V system.  When the USB host exits Suspend Mode, the FT232R will pull the line low to re-active the
MOSFET.  The datasheet for the MOSFET give a current rating of 2A at 70\textcelsius{}.

The FT232R defaults to USB low-power mode, which requires that the device in question draw at most
100mA.  Given a thermal resistance of 115\textcelsius{}/W and on-resistance of 100m\textOmega{}, a
100mA draw would raise the MOSFET's temperature over ambient by

\begin{align*}
    \Delta T &= P * R_{th} \\
    &= (I^2R) * R_{th} \\
    &= (0.01 * 0.1) * 115 \\
    \Delta T &= 0.115\degree C
\end{align*}

Both the USB connector and the FT232R are fine-pitch parts, the latter using a 28-pin SSOP package.
These two are probably the most challenging parts on the board to solder, so they will need to be
placed appropriately to help make soldering them a bit easier.

\subsubsection{Main Power Input} \label{sssec:MainPower}
The board accepts a nominal 12V supply through a screw terminal rated up to 7A input, which is much
higher than the continuous current the board is designed for (see the
\hyperref[ssec:PowerUsage]{Power Usage} and \hyperref[sssec:FanControl]{Fan Control} descriptions).

To help prevent damage from occurring due to hooking up the power supply backwards, a Rohm
Semiconductor RSQ035N03 N-channel MOSFET is placed across what is normally the current return path
and the gate connected through a 3.3k\textOmega{} resistor to the normally-positive side.  When the
power is connected correctly, the gate is pulled up to 12V and the FET is fully-on.  When the power
is connected backwards, the gate is pulled low and the MOSFET is turned off.  The MOSFET has a
steady-state current rating of 3.5A and a peak rating of 14A.  The device also has a max
on-resistance of 62m\textOmega{}.  With a maximum temperature of 150\textcelsius{} and a thermal
resistance of 100\textcelsius{}/W, at 40\textcelsius{} ambient\footnote{The inside of a projector
  will certainly be warmer then the outside air temperature, with the actual ambient temperature
  depending on where inside the projector the board is placed.  The chosen 40\textcelsius{} value is
  probably on the warmer side of normal, but provides some safety margin.  This is used as the
  ambient temp throughout this document.} the maximum power dissipated by the device is given by

\begin{align*}
    P_{max} &= \frac{T_{max}-T_{amb}}{R_{th}} \\
    &= \frac{150 - 40}{100} \\
    P_{max} &= 1.1W
\end{align*}

which gives a maximum current of

\begin{align*}
    I &= \sqrt{\frac{P}{R_{th}}} \\
    &= \sqrt{\frac{1.1}{0.062}} \\
    I &\approx 4.21A
\end{align*}

meaning that the device is limited by the specified limit of 3.5A rather than by heat.

The 5V supply comes from an ST Microelectronics L78M05C linear regulator fed from the 12V supply.
The device is rated to output currents up to 0.5A and features thermal overload shutdown that will
cut output power in order to protect itself.  The device has a maximum temperature of
150\textcelsius{} and a worst-case thermal resistance of 100\textcelsius{}/W, assuming minimal
heatsinking.

As previously stated, the 5V devices are designed to draw at most 100mA so that they can be powered
via USB.  A selector switch allows the user to select between USB and the 5V regulator as the 5V
power source.  This is useful in the case the user needs to remove the board from the projector and
connect it to the PC for configuring it.  The switch is rated for 6VDC at 300mA or 30VDC at 100mA.
The output side of the selector switch has a Cooper Bussmann PTS120630V012 PTC fuse rated at 120mA
at 23\textcelsius{}.  Using the derating curve in the datasheet shows that the hold current drops to
about 100mA at an ambient temperature of 40\textcelsius{}.  A Diodes Inc. S1M-13-F diode, rated at
1A continuous and 1000V reverse DC voltage, is placed between the regulator and 12V input to prevent
USB current from back-feeding through the regulator.  If only a USB cable is connected to the board,
only the 5V devices will be powered.

Given a worst-case thermal resistance of 100\textcelsius{}/W and nominal voltage drop of 7V, a 100mA
draw would raise the device's temperature over ambient by

\begin{align*}
    \Delta T &= P * R_{th} \\
    &= (V*I) * R_{th} \\
    &= (7 * 0.1) * 100 \\
    \Delta T &= 70\degree C
\end{align*}

Some heatsinking can be provided by englarged pads or copper pours on the board.

\subsubsection{Programming and Reset} \label{sssec:ProgReset}
The ATMega328p microcontroller can be reprogrammed using a standard 10-pin AVR ISP header.  The
pinout used should work with most, if not all, external programmers.  The microcontroller is
programmed through the SPI lines while the device is held in reset.  The 5V pin on the header allows
the board to power the programmer so that the logic signals are at the correct voltage levels.  If
the board is powered via USB, care must be taken to not exceed a total of 100mA draw when powering
the programmer in this manner.  See \hyperref[ssec:PowerUsage]{Power Usage} for more information.

The user can reset the board using a push button connected to ground.  The device's
\textoverline{RESET} pin is active low, so it is normally pulled high and pressing the button
creates a connection to ground.

\subsubsection{Analog Inputs} \label{sssec:AnalogIn}
Two of the microcontroller's analog inputs are used to monitor the 12V input and ambient temperature
from an Analog Devices TMP36 temperature sensor.

The 12V input is divided down using a simple resistive divider in an approximate 3:1 ratio, meaning that the
input into the ADC is about 1/4 the actual voltage.  More specifically, to determine the actual
voltage on the 12V input, multiply the ADC voltage by 4.03.

The TMP36 ``F Grade'' part used here has a worst-case accuracy of \textpm3\textcelsius{}.  At
0\textcelsius{} the device outputs 500mV and the output changes by 10mV/\textcelsius{}.

\subsubsection{Relay and LED Outputs} \label{sssec:RelayLED} 
Four 12V outputs are provided to control external devices.  The outputs are controlled using two ON
Semiconductor NUD3124DMT1G dual low-side drivers.  The drivers are meant to be single-chip solutions
for driving small motors and relays and so include a flyback diode and gate resistor.

The 4 connectors are 2-pin TE Connectivity Mini CT series connectors, which are 1.5mm pitch and
rated for 2A maximum.  The LED connectors will be grouped together and the relay connector separated
a bit to help differentiate them.

Three of the driver outputs are controlled by the three LED outputs on the microcontroller (see
\hyperref[sssec:Microcontroller]{Microcontroller} description).  The user can connect external LEDs
to these outputs and mount them to the projector's chassis so that the firmware's diagnostic
signaling is visible from outside the projector.  The outputs provide 12V power, so the user will
need to use an appropriate current-limiting resistor with the external LED.  Alternatively,
electronics stores sell LEDs packages with the proper resistor built in.  The current-limiting
resistors for the onboard LEDs also act as pulldowns for these outputs.

The fourth output is used as a lamp enable output and can be used to turn on, for example, an
external relay coil which in turn turns the lamp on.  This output has a 10k pulldown on it.

The high side of each output has a Cooper Bussmann PTS120630V012 PTC fuse rated at 120mA at
23\textcelsius{}.  Using the derating curve in the datasheet shows that the hold current drops to
about 100mA at an ambient temperature of 40\textcelsius{}.  Given a thermal resistance of
329\textcelsius{}/W and worst-case on-resistance of 1.1\textOmega, both outputs drawing 100mA would
raise the driver's temperature over ambient by

\begin{align*}
    \Delta T &= P * R_{th} \\
    &= (I^2R) * R_{th} \\
    &= (0.04 * 1.1) * 329 \\
    \Delta T &\approx 14.5\degree C
\end{align*}

\subsubsection{Fan Control} \label{sssec:FanControl}
A single Molex 4-pin fan header is provided for connecting a standard PWM-controlled PC fan.  The
connector is rated at 4A max per contact.  The Sense output, which acts as a tachometer signal from
the fan, is not used.  12V power is controlled by an Infineon BSP762T high-side driver.  The driver
has a worst-case on-resistance of 200m\textOmega.  With a maximum temperature of 150\textcelsius{}
and a thermal resistance of 95\textcelsius{}/W, at 40\textcelsius{} ambient the maximum power
dissipated by the device is given by

\begin{align*}
    P_{max} &= \frac{T_{max}-T_{amb}}{R_{th}} \\
    &= \frac{150 - 40}{95} \\
    P_{max} &\approx 1.15W
\end{align*}

which is below the rated absolute maximum of 1.5W and therefore gives a maximum current of

\begin{align*}
    I &= \sqrt{\frac{P}{R_{th}}} \\
    &= \sqrt{\frac{1.15}{0.2}} \\
    I &\approx 2.4A
\end{align*}

which matches the typical load current ($I_{L(nom)}$) provided in the datasheet.  Note that the
on-resistance value used will occur only when the device is operating at its max junction
temperature; the on-resistance, and therefore temperature, will usually be much lower.  Users will
be instructed to draw 2A max.

The driver has a thermal shutdown feature to protect the device in over-current or short circuit
conditions.  The device will turn the output off when in thermal overload and turn it back on when
it has cooled sufficiently.  In the case of short circuit, the driver will repeatedly turn off and
back on with a repetitive short circuit current of 7A.  The driver is not designed to continuously
operate in this state, so the user will need to take care to not leave the output shorted.

The PWM output signal is supplied from one of the microcontroller's 8-bit PWM outputs.  According to
the Intel 4-pin fan specification (available in the \texttt{/hardware/datasheets} directory of the
repository), the nominal PWM output is 25kHz.  The PWM signal goes through a TI SN74LVC1G07
non-inverting open-drain buffer since the fan pulls up the signal internally. The buffer has a max
switching time of 3.5ns, which is far faster then required by the PWM signal.  The Intel fan spec
recommends a current sink capability of 8mA.  The recommended max for the buffer is 32mA (the
absolute max is 50mA), so a user could theoretically control 4 fans using splitters assuming they do
not overload the high-side driver.

If the connected fan does not have a PWM input signal (standard PC 3-pin fan), the Projector
Controller will still provide basic on/off control with the high-side driver.

The driver input and buffer input signals each have a 10k\textOmega{} pulldown.

\subsubsection{Temperature Input} \label{sssec:TempInput}
Temperature is read using a Vishay NTCALUG02A103G 10k (\textpm2\% at 25\textcelsius) thermistor,
which is enclosed in a ring terminal for easy mounting in the projector.  The ring terminal accepts
a metric M3 screw.  The user will normally want to place the thermistor as close to the monitored
object, usually the LCD panel, as he or she can.  The user may need to try a few locations to find
the best one.

The thermistor input is a 2-pin JST PH Series connector, which is 2.0mm pitch and rated for 2A maximum.

The equation for getting the temperature from a thermistor is the Steinhart-Hart equation, which is
given by Vishay as

\[
T = \frac{1}{A + Bln\frac{R_T}{R_{25}} + Cln^2\frac{R_T}{R_{25}} + Dln^3\frac{R_T}{R_{25}}}
\]

where $R_T/R_{25}$ is the ratio between the thermistor's current resistance and its reference
resistance (10k\textOmega{} in this case).  This means that it is necessary to determine the
thermistor's current resistance and that can be done using the voltage going into the ADC.

The ADC is a Microchip MCP3301 differential SPI ADC that returns data in 13-bit two's complement
representation.  The positive input to the ADC, $IN+$, is the output of a voltage divider formed by
the thermistor and a 10k\textOmega{} resistor.  The ADC has a separate reference voltage input,
$V_{REF}$, and the input range is $\pm V_{REF}$.  To take advantage of the full 13-bit scale, a
voltage divider with two 10k\textOmega{} resistors splits the 5V input in half and the resulting
2.5V is fed into both the $V_{REF}$ and $IN-$ inputs.  If the thermistor is 25\textcelsius{}, it
will also be at 2.5V and so the ADC reading will be 0.  The ADC reading will be negative if the
thermistor is colder than 25\textcelsius{} and positive if warmer.  To get the actual voltage going
into the ADC positive input, convert the ADC reading to voltage (remember to sign-extend the
reading) and then add 2.5V to it.

The thermistor's current resistance can now be calculated with

\[
R_T = \frac{R_2*V_{in}}{V_{ADC}} - R_2
\]

which is just the standard resistor divider equation solved for $R1$ (which is $R_T$ in this case).
To get the ratio between the current resistance and the reference resistance required by the 
Steinhart-Hart equation, the above equation can be divided by $R_{25}$.  Doing that and plugging in
the appropriate values for $V_{in}$ and $R_2$ yields

\begin{align*}
    \frac{R_T}{R_{25}} &= \frac{\frac{10k * 5}{V_{out}} - 10k}{R_{25}} \\
    &= \frac{\frac{50k}{V_{out}} - 10k}{10k} \\
    \frac{R_T}{R_{25}} &= \frac{5}{V_{out}} - 1
\end{align*}

The cofficients for the Steinhart-Hart equation come from a Microsoft Excel spreadsheet on Vishay's
website at \url{http://www.vishay.com/resistors-non-linear/curve-computation-list/}.  The
spreadsheet for the NTCALUG02A103G is available in the repository at
\texttt{/hardware/datasheets/Vishay Thm Calc.xls}.  The coefficients are on the RTCOEF page of the
spreadsheet and are

\begin{align*}
    A &= 0.0033540164 \\
    B &= 0.0002565236 \\
    C &= 2.605970e-6 \\
    D &= 6.329261e-8
\end{align*}

\subsubsection{Projector On Input} \label{sssec:PJOnInput}
The controller card for the projector's LCD panel also controls the LCD's backlight and will output
a 5V or 12V signal to a backlight inverter to turn it on.  Since the projector discards the
backlight in favor of a high-power lamp, the Projector Controller has an input for that backlight
signal and will use that for the similar purpose of turning on the lamp.  The input connector is a
3-pin TE Connectivity Mini CT series connector, which is 1.5mm pitch and rated for 2A maximum.  A
3-pin connector was used to differentiate it from the output connectors; the middle pin is not used.

The used connector pins go to the input of a Vishay VOM618A-4T opto-isolator. The opto has a minimum
current transfer ratio (gain) of 160\% when the current through the LED is 1mA.  The output is a
collector-emitter junction with the LED acting as the base of a transistor, so if the forward
current through the LED is 1mA then the collector current will be 1.6mA (assuming the device is not
saturated).  The LED on the opto can handle a reverse voltage of 6V, so the user needs to be careful
when connecting an input greater than that and make sure to not connect it backwards.

The collector of the opto is connected to 5V and the emitter connects to the microcontroller input
pin and a 10k\textOmega{} pulldown, making the input active-high.  With a typical collector-emitter
saturation voltage of 0.12V (max is 0.4V), the collector current is

\begin{align*}
    I_C &= \frac{V_{in} - V_{CESat}}{R_L} \\
    &= \frac{5 - 0.12}{10k} \\
    I_C &= 0.488mA
\end{align*}

so the LED forward current times the current transfer ratio must be greater than 0.488mA in order to
drive the opto in to saturation.  This is much lower than the maximum allowed collector current of
50mA.

Between the positive input pin and the anode of the LED is a 3.3k\textOmega{} current-limiting
resistor.  An LCD controller board with a 5V backlight enable signal will, with a typical LED
forward voltage of 1.1V, need to be capable of supplying

\begin{align*}
    I_F &= \frac{V_{in} - V_f}{R_I} \\
    &= \frac{5 - 1.1}{3.3k} \\
    I_F &= 1.18mA
\end{align*}

of current.  This is very close to the test current at which the opto's transfer ratio is rated.
Using an ambient temperature of 40\textcelsius{} derates the ratio to 90\%, according to Figure 9 on
page 5 of the datasheet, giving a minimum ratio of 1.44.  This make the theoretical collector
current 1.70mA, driving the opto well into saturation.  Performing similar math for a 12V input
shows that it will need to be able to supply about 3.3mA of current and will provide a theoretical
collector current of 4.75mA.  Doing the same math, but with $V_F$ at the max of 1.6V, shows that a
5V backlight signal will supply about 1mA with a theoretical collector current of 1.44mA and a 12V
signal will supply 3.15mA with a collector current of about 4.53mA.  In short, LCD controller boards
that provide a 5V or 12V backlight signal should have no trouble driving the opto into saturation
and should be able to do so while supplying only a small amount of current.

Future LCD controller boards, however, could have a 3.3V or lower backlight control signal.  Doing
the above math again with a 3.3V signal yields an LED forward current of

\begin{align*}
    I_F &= \frac{V_{in} - V_f}{R_I} \\
    &= \frac{3.3 - 1.1}{3.3k} \\
    I_F &= 0.67mA
\end{align*}

when using the typical LED forward voltage rating.  Because the current is below the 1mA test
current used by the datasheet, a additional derating of the current transfer ratio needs to be
applied.  Figure 11 on page 5 of the datasheet shows a derating of about 75\% at 25\textcelsius{}
ambient.  Applying that to the already-derated current transfer ratio of 1.44 gives 1.08.  This means
that a 3.3V input will typically have a theoretical collector current of 0.72mA.  This is higher
than the actual collector current by about 50\%, which should drive the opto into saturation.
Unfortunately, doing the same math with the max forward voltage of 1.6V gives a forward current of
0.5mA for a collector current of 0.54mA.  Users are welcome to try a 3.3V signal with the Projector
Controller, but it is not assured to work as intended.  The user may need to use an external circuit
with a 3.3V signal to provide a higher voltage to the Projector Controller.

It should be noted that orignially a more standard zener diode circuit was considered.  However,
zener diodes appeared to be rated with a 5mA current.  This would mean that more current is required
from LCD controller boards that output their backlight signals to this board.  Drive specificatons
are rarely, if ever, available for LCD controller boards so it was decided to aim for a lower
current draw, which the VOM618A allows since its test current is 1mA.

\subsubsection{Mounting Holes} \label{sssec:MountingHoles}
The Projector Controller will have one mounting hole on each of its four corners.  The holes have a
4mm inner diameter and 10mm outer diameter for screw head clearance.  This is the same size used for
PC motherboards, so standoffs and screws that come with PC cases should be useable with this board.
The holes will accommodate either M3 metric screws or 6-32 standard UTS screws.


\subsection{Power Usage} \label{ssec:PowerUsage}
The following tables lists the current draw of the different components on the board.  When
possible, the values used are the worst-case useage given in the data sheet; actual usage should
normally be lower.  The device has 5V and 12V power, so multiplying the current given in the table
by its voltage input will give the power used.

\begin{center}
    \begin{tabular}{|l|c|l|}
        \hline
        Component & Current (mA) & Notes \\
        \hline
        \multicolumn{3}{|c|}{\textbf{5V Components}} \\
        \hline
        ATMega328p Active Current & 23 & See Note below \\
        Fox HC49SDLF 20MHz Crystal & 0.1 & Derived from ``Drive Level'' rating \\
        FT232R Operating Current & 15 & Powered only from USB VBUS \\
        FT232R USB\_PWREN Current & 0.5 & Powered only from USB VBUS \\
        12V Feedback Divider & 0.9 & R1 = 10k\textOmega{}, R2 = 3.3k\textOmega{} \\
        TMP36 Supply Current & 0.05 & \\
        BSP772T Input Current & 0.015 & Current at IN pin while device is on \\
        MCP3301 $V_{REF}$ Current &  0.15 & Current at $V_{REF}$ while clocking data \\
        MCP3301 Operating Current & 0.45 & \\
        MCP3301 2.5V Divider & 0.25 & R1 = R2 = 10k\textOmega{} \\
        Thermistor Input Current & 0.5 & Worst case is shorted thermistor \\
        VOM618A-4T Collector Current & 0.5 & Assumes $V_{CE} = 0$ \\
        Green LED & 6.1 & \\
        Yellow LED & 2 & \\
        Red LED & 1.3  & \\
        5V, 10k\textOmega{} Pulldowns (4) & 0.5 x4 & \\
        5V, 10k\textOmega{} Pullups (2) & 0.5 x2 & \\
        \textbf{Total} & \textbf{53.815} & \\ 

        \hline
        \hline

        \multicolumn{3}{|c|}{\textbf{12V Components}} \\
        \hline
        5V Component Draw & 53.815 & See above \\
        L78M05C Quiescent Current & 6 & \\
        BSP762T Operating Current & 1.3 & \\
        \textbf{Total} & \textbf{61.115} & \\
        \hline
    \end{tabular}
\end{center}

{\small \textbf{Note}: Values were taken from Section 30.7 of the datasheet and includes all peripherals and
programming current but not external IO.  This assumes a 5.0V input voltage and 20MHz clock input.}

Any external 5V devices connected to the Projector Controller, including a board-powered ISP
programmer, must keep the total current draw under 100mA.  Given the total shown above, external
devices can use up to 46mA or so.

In addition to the loads shown here, the 12V supply also needs to be able to handle the external fan
and 4 outputs.  Therefore, the user will need to determine the current draw of his or her choosen
components and size a power supply that can handle those plus another 62mA for this board.

\subsection{Microcontroller Pinout} \label{ssec:MicroPinout}
Following is a table showing how the pins on the microcontroller are used and their net names on the
schematic, if applicable.

\begin{center}
    \begin{tabular}{c|l|l|l}
        Pin \# & Pin Name & Net Name & Description \\
        \hline 
        1  & (PCINT14/\textoverline{RESET}) PC6 & \textoverline{RESET} & Active-low CPU reset line \\
        2  & (PCINT16/RXD) PD0 & UART\_RX & UART receiver input \\
        3  & (PCINT17/TXD) PD1 & UART\_TX & UART transmitter output \\
        4  & (PCINT18/INT0) PD2 & FAN\_EN & Fan power enable \\
        5  & (PCINT19/OC2B/INT1) PD3 & FAN\_PWM & 25kHz fan control PWM signal \\
        6  & (PCINT20/XCK/T0) PD4 & \abrackets{None} & Bootloader enable pin \\
        7  & VCC & \abrackets{None} & Main supply input \\
        8  & GND & \abrackets{None} & Ground \\
        9  & (PCINT6/XTAL1/TOSC1) PB6 & \abrackets{None} & 20MHz crystal oscillator input \\
        10 & (PCINT7/XTAL2/TOSC2) PB7 & \abrackets{None} & 20MHz crystal oscillator input \\
        11 & (PCINT21/OC0B/T1) PD5 & LEN\_EN\_RED & Red LED enable \\
        12 & (PCINT22/OC0A/AIN0) PD6 & LED\_EN\_YELLOW & Yellow LED enable \\
        13 & (PCINT23/AIN1) PD7 & LED\_EN\_GREEN & Green LED enable \\
        14 & (PCINT0/CLKO/ICP1) PB0 & LAMP\_EN & Lamp relay enable \\
        15 & (PCINT1/OC1A) PB1 & \abrackets{Unused} & Not used \\
        16 & (PCINT2/OC1B/SS) PB2 & \textoverline{ADC\_CS} & SPI ADC chip select \\
        17 & (PCINT3/OC2A/MOSI) PB3 & MOSI & SPI master output \\
        18 & (PCINT4/MISO) PB4 & MISO & SPI master input \\
        19 & (PCINT5/SCK) PB5 & SCK & SPI clock \\
        20 & AVCC & \abrackets{None} & Analog suppy input \\
        21 & AREF & \abrackets{None} & Analog reference voltage \\
        22 & GND & \abrackets{None} & Ground \\
        23 & (PCINT8/ADC0) PC0 & AVA\_12V\_FB & 12V supply feedback \\
        24 & (PCINT9/ADC1) PC1 & ANA\_AMBIENT & Ambient temperature reading \\
        25 & (PCINT10/ADC2) PC2 & PROJECTOR\_ON & Projector on input \\
        26 & (PCINT11/ADC3) PC3 & \abrackets{Unused} & Not used \\
        27 & (PCINT12/ADC4) PC4 & \abrackets{Unused} & Not used \\
        28 & (PCINT13/ADC5) PC5 & \abrackets{Unused} & Not used \\
    \end{tabular}
\end{center}

\subsection{Connector Pinout} \label{ssec:ConnPinout}
The following tables gives the functions of the pins on each connector.  Pin 1 on through-hole
connectors can be found by looking for the square solder pad around the through-hole.  The USB
connector is the only surface mount connector and pin 1 is denoted by a small circle next to the
pin.

\begin{description}
  \item[CON1:] Communication (USB Mini-B) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & VBUS \\
            2 & D- \\
            3 & D+ \\
            4 & ID (Not Used) \\
            5 & GND \\
        \end{tabular}
    \end{center}
  \item[CON2:] Projector On Input (Mini CT 3-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & Input positve \\
            2 & Not Used \\
            3 & Input Negative \\
        \end{tabular}
    \end{center}
  \item[CON3:] Thermistor (JST PH 2-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 5V to thermistor \\
            2 & Voltage from thermistor to ADC \\
        \end{tabular}
    \end{center}
  \item[CON4:] 12V Input (Screw Terminal) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 12V \\
            2 & Ground \\
        \end{tabular}
    \end{center}
  \item[CON5:] Fan Output (4-pin PC Fan Connector) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & Ground \\
            2 & 12V \\
            3 & Sense (Not Used) \\
            4 & Control (PWM) \\
        \end{tabular}
    \end{center}
  \item[CON6:] External Red LED (Mini CT 2-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 12V \\
            2 & Ground \\
        \end{tabular}
    \end{center}
  \item[CON7:] External Yellow LED (Mini CT 2-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 12V \\
            2 & Ground \\
        \end{tabular}
    \end{center}
  \item[CON8:] AVR ISP Header (10-pin Shrouded) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1  & MOSI (SPI Out) \\
            2  & VCC (5V) \\
            3  & LED/NC (Not Used) \\
            4  & Ground \\
            5  & Reset \\
            6  & Ground \\
            7  & SCK (SPI Clock) \\
            8  & Ground \\
            9  & MISO (SPI In) \\
            10 & Ground \\
        \end{tabular}
    \end{center}
  \item[CON9:] External Green LED (Mini CT 2-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 12V \\
            2 & Ground \\
        \end{tabular}
    \end{center}
  \item[CON10:] Lamp Relay Enable (Mini CT 2-pin) \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & 12V \\
            2 & Ground \\
        \end{tabular}
    \end{center}
  \item[JP1:] Bootloader Enable Jumper \\
    \begin{center}
        \begin{tabular}{l|l}
            Pin \# & Description \\
            \hline
            1 & Jumper Pin 1 \\
            2 & Jumper Pin 2 \\
        \end{tabular}
    \end{center}
\end{description}

\subsection{Conversion Formulas} \label{ssec:ConversionFormulas}
The conversion formulas for the analong inputs discussed earlier are available here as well for
convenience.

\subsubsection{12V Feedback}
\begin{align*}
    V_{ADC} &= \frac{5 * Counts}{1024}\\
    V_{FB}  &= V_{ADC} * 4.03
\end{align*}

\subsubsection{Ambient Temperature}
\begin{align*}
    V_{ADC} &= \frac{5 * Counts}{1024} \\
    T_{Amb} &= 100 * (V_{ADC} - 0.5)
\end{align*}

\subsubsection{Thermistor Temperature}
The MCP3301 is a signed 13-bit ADC, so the reading must be sign-extended first.

\begin{align*}
    V_{ADC} &= \frac{5 * Counts}{4096} + 2.5 \\
    R &= \frac{5}{V_{ADC}} - 1 \\
    T &= \frac{1}{A + BlnR + Cln^2R + Dln^3R}
\end{align*}

where

\begin{align*}
    A &= 0.0033540164 \\
    B &= 0.0002565236 \\
    C &= 2.605970e-6 \\
    D &= 6.329261e-8
\end{align*}

\end{document}